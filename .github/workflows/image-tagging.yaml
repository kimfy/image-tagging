name: CI

on:
  push:
    branches:
      - trunk
    tags:
      - '*.*.*'
        
env:
  CR_URL: kimiversen.azurecr.io
  CR_USERNAME: kimiversen

jobs:
  build-image:
    if: github.ref_name == 'trunk'
    runs-on: ubuntu-latest

    steps:
      - name: Log in to ACR
        run: docker login ${{ env.CR_URL }} -u ${{ env.CR_USERNAME }} -p ${{ secrets.CR_PASSWORD }}

      - name: Build image
        run: docker pull alpine:latest

      - name: Tag image
        run: docker tag alpine:latest ${{ env.CR_URLÂ }}/alpine:${{ github.sha }}

      - name: Push image
        run: docker push ${{ env.CR_URL }}/alpine:${{ github.sha }}

  retag-for-production:
    if: github.ref_type == 'tag'
    runs-on: ubuntu-latest

    steps:
      - name: Log in to ACR
        run: docker login ${{ env.CR_URL }} -u ${{ env.CR_USERNAME }} -p ${{ secrets.CR_PASSWORD }}

      - name: Pull image
        run: docker pull ${{ env.CR_URL }}/alpine:${{ github.sha }}

      - name: Tag image for production
        run: docker tag ${{ env.CR_URL }}/alpine:${{ github.sha }} ${{ env.CR_URL }}/alpine:${{ github.ref_name }}

      - name: Push image
        run: docker push ${{ env.CR_URL }}/alpine:${{ github.ref_name }}

